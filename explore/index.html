<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<script
  data-goatcounter="https://todepond.goatcounter.com/count"
  async
  src="//gc.zgo.at/count.js"></script>
<title>Pondiverse - Explore</title>
<!-- <link rel="shortcut icon" href="/favicon.png" /> -->
<!-- <meta property="og:image" content="https://todepond.com/og.png" /> -->
<!-- <meta property="og:title" content="Todepond dot com" /> -->
<!-- <meta name="twitter:card" content="summary_large_image" /> -->
<!-- <meta name="twitter:title" content="Todepond dot com" /> -->
<!-- <meta name="twitter:description" content="" /> -->
<!-- <meta name="twitter:image" content="https://todepond.com/og.png" /> -->

<link rel="stylesheet" href="/style.css" />

<h1><a href="/" class="breadcrumb">Pondiverse</a> - Explore</h1>

<header>
  <p>Here are all the creations.</p>
</header>

<main><p class="secondary loading">Loading...</p></main>

<script type="module">
  import { fetchCreations } from "/script/pondiverse.js";

  const main = document.querySelector("main");

  async function pullCreations() {
    let creations;
    try {
      creations = await fetchCreations();
    } catch (e) {
      main.innerHTML = `<p class="danger">Error fetching creations.</p>`;
    }
    renderCreations(creations, { page: 0, limit: 5 });
  }

  function renderCreations(originalCreations, { page = 0, limit = 5 }) {
    if (originalCreations.length === 0) {
      main.innerHTML = `<p class="secondary">No creations yet.</p>`;
    }

    let creations = originalCreations;

    const loading = main.querySelector(".loading");
    if (loading) {
      loading.remove();
    }

    creations = creations.sort((a, b) => {
      return new Date(b.time) - new Date(a.time);
    });
    const areThereMorePages = creations.length > (page + 1) * limit;
    creations = creations.slice(page * limit, (page + 1) * limit);

    const typesToClients = {
      "screenpond": "https://screenpond.cool/",
      "chaoskit": "https://evolved.systems/chaoskit/",
      "pNMRsimJS": "https://mags.omg.lol/simulator.php",
    };
    
    const creationElements = creations.map((creation) => {
      if (typesToClients[creation.type]) {
      return `
        <div class="creation">
          <h2>${creation.title}, <a href=${typesToClients[creation.type]}>${creation.type}</a></h2>
          <img id="c${creation.id}" src="https://todepond--56fe958021f911f0a9ab569c3dd06744.web.val.run/?c=${creation.id}" alt="${creation.title}" />
        </div>
      `;
      }
      else {
        return `
        <div class="creation">
          <h2>${creation.title}, ${creation.type}</h2>
          <img id="c${creation.id}" src="https://todepond--56fe958021f911f0a9ab569c3dd06744.web.val.run/?c=${creation.id}" alt="${creation.title}" />
        </div>
      `;
      }
    });
    main.innerHTML += creationElements.join("");

    for (const creation of creations) {
      const img = document.getElementById(`c${creation.id}`);
      img.onerror = () => {
        img.src = creation.image;
        img.onerror = () => {}
      };
    }

    if (areThereMorePages) {
      const button = document.createElement("button");
      const br = document.createElement("br");
      button.innerText = "Load more";
      button.onclick = () => {
        button.remove();
        br.remove();
        renderCreations(originalCreations, { page: page + 1, limit });
      };
      main.appendChild(br);
      main.appendChild(button);
    }
  }

  pullCreations();
</script>
