<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<script
  data-goatcounter="https://todepond.goatcounter.com/count"
  async
  src="//gc.zgo.at/count.js"></script>
<title>Pondiverse - Explore</title>
<!-- <link rel="shortcut icon" href="/favicon.png" /> -->
<!-- <meta property="og:image" content="https://todepond.com/og.png" /> -->
<!-- <meta property="og:title" content="Todepond dot com" /> -->
<!-- <meta name="twitter:card" content="summary_large_image" /> -->
<!-- <meta name="twitter:title" content="Todepond dot com" /> -->
<!-- <meta name="twitter:description" content="" /> -->
<!-- <meta name="twitter:image" content="https://todepond.com/og.png" /> -->

<link rel="stylesheet" href="/style.css" />

<h1><a href="/" class="breadcrumb">Pondiverse</a> - Explore</h1>
<header
  id="view-source"
  style="position: absolute; top: 0; right: 0; padding: 16px">
  <a href="https://github.com/TodePond/Pondiverse" target="_blank"
    >View source</a
  >
</header>
<header>
  <p>Here are all the creations.</p>
</header>

<main><p class="secondary loading">Loading...</p></main>

<script type="module">
  import {
    fetchPondiverseCreations,
    getPondiverseCreationImageUrl,
  } from "/pondiverse.js";
  import config from "/rubbish.js";

  const main = document.querySelector("main");

  async function pullCreations(page) {
    let creations;
    try {
      creations = await fetchPondiverseCreations(page);
    } catch (e) {
      main.innerHTML = `<p class="danger">Error fetching creations.</p>`;
    }
    renderMoreCreations(creations, page);
  }

  function renderMoreCreations(originalCreations, page) {
    let areThereMorePages = true;

    if (originalCreations.length === 0) {
      main.innerHTML += `<p class="secondary">
          No more creations yet.
          <a href="/create/">Create one yourself?</a>
        </p>`;
      areThereMorePages = false;
    }

    let creations = originalCreations;

    const loading = main.querySelector(".loading");
    if (loading) {
      loading.remove();
    }

    creations = creations.sort((a, b) => {
      return new Date(b.time) - new Date(a.time);
    });

    const creationElements = creations.map((creation) => {
      let prettyData = "";
      try {
        prettyData = JSON.stringify(JSON.parse(creation.data), null, 2);
      } catch (e) {
        prettyData = creation.data;
      }

      const tool = config.tools.find((t) => t.types.creates === creation.type);

      const imageEl = `<img
        id="c${creation.id}"
        src="${getPondiverseCreationImageUrl(creation.id)}"
        alt="${creation.title}" />`;

      return `
        <div class="creation">
          <h2>${
            tool?.urls.create
              ? `${creation.title}, <a href=${tool.urls.create}>${creation.type}</a>`
              : `${creation.title}, ${creation.type}`
          }</h2>
          ${
            tool?.urls.open
              ? `<a title="open with ${tool.name}" href="${
                  tool.urls.open + creation.id
                }">${imageEl}</a>`
              : imageEl
          }
          <details>
            <summary>show data</summary>
            <pre class="data-preview"><code>${prettyData}</code></pre>
          </details>
        </div>
      `;
    });
    main.innerHTML += creationElements.join("");

    for (const creation of creations) {
      const img = document.getElementById(`c${creation.id}`);
      img.onerror = () => {
        img.remove();
      };
    }

    if (areThereMorePages) {
      const button = document.createElement("button");
      const br = document.createElement("br");
      button.innerText = "Load more";
      button.onclick = async () => {
        button.innerText = "Loading...";
        button.disabled = true;
        button.style.cursor = "not-allowed";
        const moreCreations = await fetchCreations(page + 1);
        button.remove();
        br.remove();
        renderMoreCreations(moreCreations, page + 1);
      };
      main.appendChild(br);
      main.appendChild(button);
    }
  }

  pullCreations(1);
</script>
