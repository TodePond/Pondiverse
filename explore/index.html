<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Pondiverse - Explore</title>
<link rel="stylesheet" href="/style.css" />
<h1><a href="/" class="breadcrumb">Pondiverse</a> - Explore</h1>
<header
  id="view-source"
  style="position: absolute; top: 0; right: 0; padding: 16px">
  <a href="https://github.com/TodePond/Pondiverse" target="_blank"
    >View source</a
  >
</header>
<header>
  <p>Here are all the creations.</p>
</header>

<main><p class="secondary loading">Loading...</p></main>

<script type="module">
  import {
    fetchPondiverseCreations,
    getPondiverseCreationImageUrl,
  } from "/pondiverse.js";
  import { tools } from "/tools.js";
  import { instances } from "/instances.js";

  const main = document.querySelector("main");

  const CREATIONS_PER_PAGE = 10;
  async function pullCreations() {
    let allCreations = [];

    for (const instance of instances) {
      let creations;
      try {
        creations = await fetchPondiverseCreations({ instance });
      } catch (e) {
        main.innerHTML = `<p class="danger">Error fetching creations.</p>`;
        throw e;
      }
      allCreations.push(
        ...creations.map((creation) => {
          return {
            ...creation,
            instance,
          };
        })
      );
    }
    allCreations = allCreations.sort((a, b) => {
      return new Date(b.time) - new Date(a.time);
    });
    const head = allCreations.slice(0, CREATIONS_PER_PAGE);
    const tail = allCreations.slice(CREATIONS_PER_PAGE);
    renderMoreCreations({ head, tail });
  }

  function getTimeSince(timestamp) {
    const now = new Date();
    const past = new Date(timestamp);
    const diffInMilliseconds = now.getTime() - past.getTime();
    const diffInSeconds = Math.floor(diffInMilliseconds / 1000);
    const diffInMinutes = Math.floor(diffInSeconds / 60);
    const diffInHours = Math.floor(diffInMinutes / 60);

    if (diffInHours > 0) {
      return `${diffInHours} hour${diffInHours > 1 ? "s" : ""} ago`;
    } else if (diffInMinutes > 0) {
      return `${diffInMinutes} minute${diffInMinutes > 1 ? "s" : ""} ago`;
    } else {
      return `${diffInSeconds} second${diffInSeconds > 1 ? "s" : ""} ago`;
    }
  }

  function renderMoreCreations({ head, tail }) {
    if (head.length === 0) {
      main.innerHTML += `<p class="secondary">
          No more creations yet.
          <a href="/create/">Create one yourself?</a>
        </p>`;
    }

    let creations = head;

    const loading = main.querySelector(".loading");
    if (loading) {
      loading.remove();
    }

    // creations = creations.sort((a, b) => {
    //   return new Date(b.time) - new Date(a.time);
    // });

    const creationElements = creations.map((creation) => {
      let prettyData = "";
      try {
        prettyData = JSON.stringify(JSON.parse(creation.data), null, 2);
      } catch (e) {
        prettyData = creation.data;
      }

      const imageUrl = getPondiverseCreationImageUrl(creation, {
        instance: creation.instance,
      });

      const compatibleTools = tools.filter((tool) => {
        if (tool.types.includes("*")) return true;
        return tool.types.includes(creation.type);
      });

      const canOpen = compatibleTools.length > 0;
      const openInSection = canOpen
        ? compatibleTools.map((tool) => {
            const toolName = tool.name;
            const toolUrl = tool.url;
            return `<p>Open in <a href="${toolUrl}${creation.instance.getCreation}${creation.id}" target="_blank">${toolName}</a></p>`;
          })
        : ``;

      const detailsSection = creation.data
        ? `
          <details>
            <summary>show data</summary>
            <pre class="data-preview"><code>${prettyData}</code></pre>
          </details>
        `
        : "";

      const timeSince = getTimeSince(creation.time);

      const from = creation.instance.home
        ? `<a class="tertiary" href="${creation.instance.home}">${creation.instance.name}</a>`
        : creation.instance.name;
      return `
        <div class="creation" id="c${creation.id}">
          <h2>${creation.title}, ${creation.type}</h2>
          ${openInSection}
          ${imageUrl ? `<img src="${imageUrl}" alt="${creation.title}" />` : ""}
          ${detailsSection}
          <p class="secondary">From ${from}, about ${timeSince}</p>
        </div>
      `;
    });
    main.innerHTML += creationElements.join("");

    for (const creation of creations) {
      const img = document.querySelector(`#c${creation.id} img`);
      if (img) img.onerror = () => img.remove();
    }

    const areThereMorePages = tail.length > 0;
    if (areThereMorePages) {
      const button = document.createElement("button");
      const br = document.createElement("br");
      button.innerText = "Load more";
      button.onclick = async () => {
        button.innerText = "Loading...";
        button.disabled = true;
        button.style.cursor = "not-allowed";
        const _head = tail.slice(0, CREATIONS_PER_PAGE);
        const _tail = tail.slice(CREATIONS_PER_PAGE);
        button.remove();
        br.remove();
        renderMoreCreations({ head: _head, tail: _tail });
      };
      main.appendChild(br);
      main.appendChild(button);
    }
  }

  pullCreations();
</script>
