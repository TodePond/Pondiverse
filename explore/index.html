<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Pondiverse - Explore</title>
<link rel="stylesheet" href="/style.css" />
<h1><a href="/" class="breadcrumb">Pondiverse</a> - Explore</h1>
<header id="view-source" style="position: absolute; top: 0; right: 0; padding: 16px">
  <a href="https://github.com/TodePond/Pondiverse" target="_blank">View source</a>
</header>
<header>
  <p>Here are all the creations.</p>
</header>

<main>
  <h2 id="refresh-heading">
    Creations <button id="refresh-sign" class="secondary span">Loading...</button>
  </h2>
  <p class="secondary loading">Loading creations...</p>
</main>

<script type="module">
  import {
    fetchPondiverseCreations,
    getPondiverseCreationImageUrl,
  } from "/pondiverse.js";
  import { tools } from "/tools.js";
  import { instances } from "/instances.js";

  const main = document.querySelector("main");
  const refreshSign = document.querySelector("#refresh-sign");
  const refreshHeading = document.querySelector("#refresh-heading");

  const CREATIONS_PER_PAGE = 10;
  let displayedCreationIds = new Set();
  let isInitialLoad = true;

  let refreshTimeout;
  let secondsLeft = 9;
  const REFRESH_INTERVAL_SECONDS = 9;
  const LOCAL_STORAGE_KEY = "pondiverseExploreAutoRefreshIncremental";

  function getLocalRefreshStatus() {
    return localStorage.getItem(LOCAL_STORAGE_KEY) !== "false";
  }

  function setLocalRefreshStatus(on) {
    localStorage.setItem(LOCAL_STORAGE_KEY, on ? "true" : "false");
  }

  function getRefreshStatus() {
    return refreshTimeout !== undefined;
  }

  async function handleTimer() {
    secondsLeft--;
    if (secondsLeft <= 0) {
      await pullCreations();
      return;
    }

    if (getLocalRefreshStatus()) {
      refreshSign.textContent = "Checking in " + secondsLeft;
    } else {
      refreshSign.textContent = "Auto-refresh paused";
      clearTimeout(refreshTimeout);
      refreshTimeout = undefined;
      return;
    }

    if (refreshTimeout !== undefined) {
      clearTimeout(refreshTimeout);
    }
    refreshTimeout = setTimeout(handleTimer, 1000);
  }

  function setRefreshStatus(on) {
    setLocalRefreshStatus(on);
    if (on) {
      if (!getRefreshStatus()) {
        secondsLeft = REFRESH_INTERVAL_SECONDS;
        refreshSign.textContent = "Checking in " + secondsLeft;
        if (refreshTimeout !== undefined) clearTimeout(refreshTimeout);
        refreshTimeout = setTimeout(handleTimer, 1000);
      }
    } else {
      refreshSign.textContent = "Auto-refresh paused";
      if (getRefreshStatus()) {
        clearTimeout(refreshTimeout);
        refreshTimeout = undefined;
      }
    }
  }

  function toggleRefresh() {
    const currentlyRefreshing = getLocalRefreshStatus();
    setRefreshStatus(!currentlyRefreshing);
    if (!currentlyRefreshing) {
      pullCreations(); // Trigger an immediate check if turning on
    }
  }

  async function pullCreations() {
    if (getLocalRefreshStatus() || isInitialLoad) {
      refreshSign.textContent = isInitialLoad ? "Loading..." : "Checking...";
    }

    if (refreshTimeout !== undefined) {
      clearTimeout(refreshTimeout);
      refreshTimeout = undefined;
    }
    secondsLeft = REFRESH_INTERVAL_SECONDS;

    let allCreations = [];
    let fetchError = false;

    try {
      const fetchPromises = instances.map(instance =>
        fetchPondiverseCreations({ instance })
          .then(creations => creations.map(creation => ({ ...creation, instance })))
          .catch(e => {
            console.error(`Error fetching from ${instance.name}:`, e);
            fetchError = true;
            // Optionally display instance-specific errors visually if needed
            // For incremental, we might just log it unless it's critical
            return []; // Return empty array for this instance on error
          })
      );
      const results = await Promise.all(fetchPromises);
      allCreations = results.flat();

    } catch (globalError) {
      console.error("Error during creation fetch coordination:", globalError);
      fetchError = true;
      // Handle global fetch error display if necessary
    }

    if (isInitialLoad) {
      const loadingIndicator = main.querySelector('.loading');
      if (loadingIndicator) loadingIndicator.remove();

      if (allCreations.length > 0) {
        allCreations.sort((a, b) => new Date(b.time) - new Date(a.time));
        // Display initial batch
        const initialBatch = allCreations.slice(0, CREATIONS_PER_PAGE * 2); // Load a bit more initially
        renderCreations(initialBatch, true); // true indicates initial render
        initialBatch.forEach(c => displayedCreationIds.add(c.id));
      } else if (!fetchError) {
        main.innerHTML += `<p class="secondary">No creations found yet.</p>`;
      } else {
        main.innerHTML += `<p class="danger">Could not load initial creations. Please try again later.</p>`;
      }
      isInitialLoad = false;

    } else { // Incremental check
      const newCreations = allCreations
        .filter(c => !displayedCreationIds.has(c.id))
        .sort((a, b) => new Date(b.time) - new Date(a.time)); // Sort only new ones

      if (newCreations.length > 0) {
        renderCreations(newCreations, false); // false indicates prepending
        newCreations.forEach(c => displayedCreationIds.add(c.id));
        refreshSign.textContent = `Added ${newCreations.length} new`;
        setTimeout(() => {
          if (getLocalRefreshStatus()) {
            refreshSign.textContent = "Checking in " + secondsLeft;
          }
        }, 2000); // Show for 2 seconds
      } else {
        if (getLocalRefreshStatus()) {
          refreshSign.textContent = "Checking in " + secondsLeft;
        }
      }
    }

    if (getLocalRefreshStatus() && !isInitialLoad) { // Don't start timer during initial load message
      if (refreshTimeout === undefined) { // Prevent multiple timers
        refreshTimeout = setTimeout(handleTimer, 1000);
      }
    } else if (getLocalRefreshStatus() && isInitialLoad) {
      refreshTimeout = setTimeout(handleTimer, 1000);
    } else {
      refreshSign.textContent = "Auto-refresh paused";
    }
  }

  function getTimeSince(timestamp) {
    const now = new Date();
    const past = new Date(timestamp);
    const diffInMilliseconds = now.getTime() - past.getTime();
    if (diffInMilliseconds < 0) return "just now";
    const diffInSeconds = Math.floor(diffInMilliseconds / 1000);
    const diffInMinutes = Math.floor(diffInSeconds / 60);
    const diffInHours = Math.floor(diffInMinutes / 60);
    const diffInDays = Math.floor(diffInHours / 24);
    if (diffInDays > 0) return `${diffInDays} day${diffInDays > 1 ? "s" : ""} ago`;
    if (diffInHours > 0) return `${diffInHours} hour${diffInHours > 1 ? "s" : ""} ago`;
    if (diffInMinutes > 0) return `${diffInMinutes} minute${diffInMinutes > 1 ? "s" : ""} ago`;
    return `${diffInSeconds === 1 ? '1 second' : diffInSeconds + ' seconds'} ago`;
  }

  function renderCreations(creationsToRender, isInitial) {
    if (creationsToRender.length === 0) return;

    const fragment = document.createDocumentFragment();

    creationsToRender.forEach((creation) => {
      let prettyData = "";
      try {
        if (creation.data && typeof creation.data === 'string' && (creation.data.trim().startsWith('{') || creation.data.trim().startsWith('['))) {
          prettyData = JSON.stringify(JSON.parse(creation.data), null, 2);
        } else {
          prettyData = creation.data || "";
        }
      } catch (e) {
        prettyData = creation.data || "";
      }
      const escapedPrettyData = prettyData.replace(/</g, "<").replace(/>/g, ">");
      const imageUrl = getPondiverseCreationImageUrl(creation, { instance: creation.instance });
      const compatibleTools = tools.filter((tool) => {
        if (!tool.types) return false;
        if (tool.types.includes("*")) return true;
        return tool.types.includes(creation.type);
      });
      const canOpen = compatibleTools.length > 0;
      const openInSection = canOpen ? compatibleTools.map((tool) => {
        const toolName = tool.name;
        const toolUrl = tool.url;
        const targetUrl = `${toolUrl.endsWith('/') ? toolUrl : toolUrl + '/'}${creation.instance.getCreation}${creation.id}`;
        return `<p>Open in <a href="${targetUrl}" target="_blank">${toolName}</a></p>`;
      }).join("") : ``;
      const detailsSection = creation.data ? `<details><summary>show data</summary><pre class="data-preview"><code>${escapedPrettyData}</code></pre></details>` : "";
      const timeSince = getTimeSince(creation.time);
      const from = creation.instance.home ? `<a class="tertiary" href="${creation.instance.home}" target="_blank" rel="noopener noreferrer">${creation.instance.name}</a>` : creation.instance.name;

      const div = document.createElement('div');
      div.className = 'creation';
      div.id = `c${creation.id}`;
      div.innerHTML = `
          <h2>${creation.title || 'Untitled'}, ${creation.type || 'Unknown Type'}</h2>
          ${openInSection}
          ${imageUrl ? `<img src="${imageUrl}" alt="${creation.title || 'Creation image'}" loading="lazy" />` : ""}
          ${detailsSection}
          <p class="secondary">From ${from}, about ${timeSince}</p>
        `;

      if (imageUrl) {
        const img = div.querySelector('img');
        if (img) {
          img.onerror = () => {
            console.warn(`Failed to load image: ${img.src}`);
            img.remove();
          };
        }
      }
      fragment.appendChild(div);
    });

    if (isInitial) {
      main.appendChild(fragment);
    } else {
      refreshHeading.after(fragment);
    }
  }


  refreshSign.addEventListener("click", toggleRefresh);

  if (!getLocalRefreshStatus()) {
    refreshSign.textContent = "Auto-refresh paused";
    isInitialLoad = false; // Don't show initial loading if paused from start
    const loadingIndicator = main.querySelector('.loading');
    if (loadingIndicator) loadingIndicator.remove();
    main.innerHTML += `<p class="secondary">Auto-refresh is paused. <a href="#" onclick="document.getElementById('refresh-sign').click(); return false;">Click here</a> to load and enable.</p>`;

  } else {
    pullCreations(); // Start initial load
  }

</script>